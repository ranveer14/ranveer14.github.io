<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">

  <head>
    <!-- General meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    {% if page.indexing == false %}
      <meta name="robots" content="noindex">
    {% endif %}

    {% if page.collectionpage %}
      {% seo title=false %}

      {% assign collectiondata = site.collections | where: "label", page.collectionpage | first %}
      <title>{{ collectiondata.title }} - {{ site.title }}</title>
      <meta property="og:title" content="{{ collectiondata.title }}">
      <meta name="description" content="{{ collectiondata.description }}">
      <meta property="og:description" content="{{ collectiondata.description }}">
    {% else %}
      {% seo %}
    {% endif %}

    <link rel="manifest" href="{{ "/manifest.json" | relative_url }}">
    <meta name="theme-color" content="{{ site.manifest.theme_color | default: '#242e2b' }}"/>

    {% if site.css_inline == true %}
      {% include site-styles.html %}
    {% else %}
      <link rel="stylesheet" href="{{ "/assets/styles.css" | relative_url }}">
    {% endif %}

    {% if site.favicons or site.avatarurl %}{% include site-favicons.html %}{% endif %}

    {% if site.google_analytics %}{% include site-analytics.html %}{% endif %}

    {% include site-before-start.html %}
  </head>

  <body class="layout-{{ page.layout }}{% if page.title %}  {{ page.title | slugify }}{% endif %}">
    {% include site-icons.svg %}

    {{ content }}

    {% if site.service_worker != false %}{% include site-sw.html %}{% endif %}

    {% include site-before-end.html %}
    <!-- ===== Mini Pomodoro Widget ===== -->
<div id="mini-pomodoro" style="
  position: fixed;
  top: 10px;
  right: 10px;
  width: 120px;
  height: 120px;
  background: #0b1328;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-family: sans-serif;
  color: #fff;
  z-index: 9999;
  cursor: pointer;
">
  <svg width="60" height="60" style="position:absolute; top:10px; left:50%; transform:translateX(-50%);">
    <circle cx="30" cy="30" r="28" fill="none" stroke="#23304d" stroke-width="4"></circle>
    <circle id="mini-progress" cx="30" cy="30" r="28" fill="none" stroke="#75e0a3" stroke-width="4" stroke-linecap="round" stroke-dasharray="176" stroke-dashoffset="176"></circle>
  </svg>
  <div id="mini-time" style="font-size:16px; margin-top:40px;">25:00</div>
  <div id="mini-mode" style="font-size:12px; margin-top:4px;">Work • Cycle 1/4</div>
  <button id="mini-start" style="
    margin-top:6px;
    font-size:12px;
    padding:2px 6px;
    border:none;
    border-radius:8px;
    background:#75e0a3;
    color:#0b1328;
    cursor:pointer;
  ">Start</button>
</div>

<script>
(function(){
  const LS_KEY = 'pomodoro.v1';
  const POMODORO_URL = '/pomodoro/';
  const CIRC = 2*Math.PI*28;

  const miniTime = document.getElementById('mini-time');
  const miniMode = document.getElementById('mini-mode');
  const miniStart = document.getElementById('mini-start');
  const miniProgress = document.getElementById('mini-progress');
  const widget = document.getElementById('mini-pomodoro');

  let timer = {
    mode: 'work',
    cycle: 1,
    running: false,
    startAt: null,
    endsAt: null,
    remaining: 25*60*1000
  };

  widget.addEventListener('click', ()=>{ window.location.href = POMODORO_URL; });

  miniStart.addEventListener('click', (e)=>{
    e.stopPropagation(); // prevent opening Pomodoro page
    if(timer.running) pauseTimer();
    else startTimer();
  });

  function loadSettings(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const s = JSON.parse(raw);
      timer.mode = s.mode || 'work';
      timer.cycle = s.cycle || 1;
      timer.running = s.running || false;
      timer.startAt = s.startAt || null;
      timer.endsAt = s.endsAt || null;
      const mins = getModeMinutes(timer.mode);
      timer.remaining = timer.running && timer.endsAt ? Math.max(0, timer.endsAt - Date.now()) : mins*60*1000;
    } catch{}
  }

  function getModeMinutes(mode){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY)) || {};
      if(mode==='work') return Number(s.work||25);
      if(mode==='short') return Number(s.short||5);
      if(mode==='long') return Number(s.long||15);
      return 25;
    } catch{ return 25; }
  }

  function updateUI(){
    const mm = String(Math.floor(timer.remaining/60000)).padStart(2,'0');
    const ss = String(Math.ceil((timer.remaining%60000)/1000)).padStart(2,'0');
    miniTime.textContent = `${mm}:${ss}`;
    miniMode.textContent = (timer.mode==='work'?'Work':(timer.mode==='short'?'Short':'Long')) + ` • Cycle ${timer.cycle}/4`;
    miniStart.textContent = timer.running ? 'Pause' : 'Start';

    const full = getModeMinutes(timer.mode)*60*1000;
    const p = full===0 ? 1 : 1 - timer.remaining/full;
    miniProgress.setAttribute('stroke-dashoffset', String(CIRC*(1-p)));
  }

  let tickId = null;
  function startTimer(){
    if(timer.running) return;
    const full = getModeMinutes(timer.mode)*60*1000;
    timer.startAt = Date.now();
    timer.endsAt = Date.now() + timer.remaining;
    timer.running = true;

    tickId = setInterval(()=>{
      timer.remaining = Math.max(0, timer.endsAt - Date.now());
      if(timer.remaining <= 0){
        clearInterval(tickId); timer.running=false;
        timer.remaining = full;
        // Force all tabs to Pomodoro page
        localStorage.setItem(LS_KEY+'.redirect', Date.now());
        window.location.href = POMODORO_URL;
      }
      updateUI();
    }, 200);
    updateUI();
  }

  function pauseTimer(){
    timer.running=false;
    clearInterval(tickId); tickId=null;
    timer.remaining = Math.max(0, timer.endsAt - Date.now());
    updateUI();
  }

  // Listen to cross-tab redirect
  window.addEventListener('storage', e=>{
    if(e.key===LS_KEY+'.redirect') window.location.href = POMODORO_URL;
  });

  loadSettings();
  updateUI();
  setInterval(updateUI, 1000);
})();
</script>

  </body>

</html>
